services:
  - docker
env:
  matrix:
  - VERSION=15.0.4 LATEST_MINOR=true
  - VERSION=14.0.7 LATEST_MINOR=true
  - VERSION=13.0.9 LATEST_MINOR=true
before_install:
  - sudo apt-get install -y pwgen
  - docker --version
  - docker-compose --version
  - git clone https://github.com/tob123/circleci_anchore
script:
  - export NC_PASS_CI=`pwgen -s -N1 20`
  - export DB_PASS_CI=`pwgen -s -N1 20`
  - export MYSQL_ROOT_PASSWORD_CI=`pwgen -s -N1 20`
  - docker-compose -f ./nc/docker-compose.test.yml up -d --build
  - docker container ls
  - docker inspect --format="{{json .State.Health.Status}}" nc_sut_1
  - |
    SUT_HEALTH="notok" && counter=0
    while [ $SUT_HEALTH != "healthy" ] && [ $counter -le 30 ]; do
    SUT_HEALTH=$(docker inspect --format="{{json .State.Health.Status}}" nc_sut_1)
    sleep 2
    counter=$(( $counter + 1 ))
    done
  - docker inspect --format="{{json .State.Health.Status}}" nc_sut_1
  - docker logs nc_sut_1
after_script:
  - docker container ls
  - docker image ls
before_deploy:
  - echo "$DOCKER_HUB_P" | docker login -u "$DOCKER_HUB_U" --password-stdin
  - docker container ls
  - docker image ls
deploy:
  - provider: script
    skip_cleanup: true
    script: bash dockpush.sh
  - provider: pages
    skip_cleanup: true
    github-token: $GITHUB_TOKEN
    local-dir: ./circleci_anchore
    repo: tob123/circleci_anchore
    keep-history: true
    target-branch: master
    on:
      branch: master
